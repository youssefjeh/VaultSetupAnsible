---
- name: Load auto-unseal token from controller
  delegate_to: localhost
  slurp:
    src: "./auto_unseal_token.txt"
  register: unseal_token_raw

- name: Set auto-unseal token fact
  set_fact:
    auto_unseal_token: "{{ unseal_token_raw.content | b64decode }}"

- name: Apply Vault configuration
  template:
    src: vault.hcl.j2
    dest: /etc/vault.d/vault.hcl
    owner: "{{ vault_user }}"
    group: "{{ vault_group }}"
    mode: '0644'

- name: Start Vault service
  systemd:
    name: vault
    state: started
    enabled: yes

- name: Check if Vault is already initialized
  command: vault status -format=json
  environment:
    VAULT_ADDR: "{{ VAULT_ADDR }}"
  register: vault_status
  ignore_errors: yes

- name: Initialize Vault Master if not already initialized
  command: vault operator init -format=json
  environment:
    VAULT_ADDR: "{{ VAULT_ADDR }}"
  register: vault_master_init
  changed_when: true
  when: vault_status.rc != 0 or (vault_status.stdout | from_json).initialized == false

- name: Save master init output locally (only if initialized)
  delegate_to: localhost
  copy:
    dest: "./vault_master_init.json"
    content: "{{ vault_master_init.stdout }}"
    mode: '0600'
  when: vault_master_init is defined

- name: Load unseal keys
  delegate_to: localhost
  set_fact:
    vault_unseal_keys: >-
      {{
        (vault_master_init.stdout | from_json).unseal_keys_b64
        if vault_master_init is defined
        else (lookup('file', './vault_master_init.json') | from_json).unseal_keys_b64
      }}

- name: Unseal Vault Master
  command: "vault operator unseal {{ item }}"
  loop: "{{ vault_unseal_keys }}"
  environment:
    VAULT_ADDR: "{{ VAULT_ADDR }}"

- name: Set Vault root token fact
  set_fact:
    vault_root_token: >-
      {{
        (vault_master_init.stdout | from_json).root_token
        if vault_master_init is defined
        else (lookup('file', './vault_master_init.json') | from_json).root_token
      }}

---
- name: Load unseal token from controller
  delegate_to: localhost
  slurp:
    src: "./auto_unseal_token.txt"
  register: unseal_token_raw

- set_fact:
    unseal_token: "{{ unseal_token_raw.content | b64decode }}"

- name: Create vault.hcl for Vault_Master
  copy:
    dest: /etc/vault.d/vault.hcl
    owner: vault
    group: vault
    mode: '0644'
    content: |
      storage "raft" {
        path    = "/opt/vault/data"
        node_id = "{{ inventory_hostname }}"
      }

      ui = true
      disable_mlock = true

      api_addr = "http://{{ ansible_host }}:8200"
      cluster_addr = "http://{{ ansible_host }}:8201"

      listener "tcp" {
        address = "0.0.0.0:8200"
        tls_disable = 1
      }

      seal "transit" {
        address    = "http://{{ hostvars['Auto_Unseal_Provider'].ansible_host }}:8200"
        token      = "{{ unseal_token }}"
        key_name   = "autounseal-key"
        mount_path = "transit/"
      }

- name: Enable and start Vault
  systemd:
    name: vault
    enabled: yes
    state: started

- name: Check if Vault is already initialized
  ansible.builtin.command: vault status -format=json
  register: vault_status
  failed_when: false
  changed_when: false
  environment:
    VAULT_ADDR: "http://127.0.0.1:8200"

- name: Initialize Vault if not already initialized
  ansible.builtin.command: vault operator init -format=json
  register: vault_master_init_raw
  environment:
    VAULT_ADDR: "http://127.0.0.1:8200"
  changed_when: true
  failed_when: false
  when: (vault_status.stdout | from_json).initialized == false

- name: Load Vault master init from file if not just initialized
  delegate_to: localhost
  slurp:
    src: "./vault_master_init.json"
  register: vault_master_file
  when: vault_master_init_raw is not defined or vault_master_init_raw.stdout is not defined

- name: Set vault_master_init fact
  set_fact:
    vault_master_init: "{{ vault_master_init_raw.stdout | from_json if (vault_master_init_raw is defined and vault_master_init_raw.stdout is defined) else vault_master_file.content | b64decode | from_json }}"

- name: Save master init output if just initialized
  delegate_to: localhost
  copy:
    dest: "./vault_master_init.json"
    content: "{{ vault_master_init_raw.stdout }}"
    mode: '0600'
  when: vault_master_init_raw is defined and vault_master_init_raw.stdout is defined

- name: Unseal Vault if sealed
  ansible.builtin.command: "vault operator unseal {{ item }}"
  loop: "{{ vault_master_init.unseal_keys_b64 }}"
  environment:
    VAULT_ADDR: "http://127.0.0.1:8200"
  when: (vault_status.stdout | from_json).sealed == true

- name: Login using root token
  ansible.builtin.command: "vault login {{ vault_master_init.root_token }}"
  environment:
    VAULT_ADDR: "http://127.0.0.1:8200"
